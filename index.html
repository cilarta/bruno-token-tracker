<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Token Economy Tracker v125 Firebase</title>
    <style>
        :root {
            --primary: #3182f6;
            --primary-dark: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-700: #374151;
            --gray-900: #111827;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--gray-100);
            color: var(--gray-900);
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .token-display {
            font-size: 24px;
            color: var(--primary);
            font-weight: bold;
            margin: 15px 0;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            font-size: 18px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--gray-200);
        }

        .base-color {
            border-left: 4px solid var(--success);
        }

        .pro-color {
            border-left: 4px solid var(--warning);
        }

        .vip-color {
            border-left: 4px solid var(--danger);
        }

        .item-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--gray-100);
            border-radius: 8px;
            font-size: 14px;
        }

        .item-name {
            flex: 1;
        }

        .token-badge {
            background: var(--primary);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 12px;
        }

        .penalties-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1px;
            background: var(--gray-200);
            border-radius: 8px;
            overflow: hidden;
            margin-top: 15px;
            border: 1px solid var(--gray-200);
        }

        .penalty-header {
            display: flex;
            justify-content: space-between;
            background: var(--gray-100);
            padding: 12px 15px;
            font-weight: bold;
            color: var(--gray-700);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .penalty-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 12px 15px;
            font-size: 14px;
        }

        .penalty-row:hover {
            background: #fef2f2;
        }

        .penalty-badge {
            background: #fee2e2;
            color: var(--danger);
            font-weight: bold;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 13px;
            min-width: 40px;
            text-align: center;
        }

        .section-title {
            background: var(--primary);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0 15px;
            font-size: 16px;
            font-weight: bold;
        }

        .premi-item {
            background: var(--gray-100);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .premi-header {
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .premi-option {
            font-size: 13px;
            margin: 5px 0 5px 20px;
        }

        .footer {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 13px;
            color: var(--gray-700);
            margin-top: 30px;
        }

        .edit-section {
            background: var(--gray-100);
            padding: 20px;
            border-radius: 10px;
            margin: 30px 0;
        }

        .edit-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        input[type="password"],
        input[type="number"],
        input[type="text"],
        select {
            padding: 8px 12px;
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            font-size: 14px;
        }

        button {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .status {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--gray-100);
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .history-type {
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 11px;
        }

        .type-base {
            background: var(--success);
            color: white;
        }

        .type-pro {
            background: var(--warning);
            color: white;
        }

        .type-vip {
            background: var(--danger);
            color: white;
        }

        .type-penalty {
            background: #6b7280;
            color: white;
        }

        .type-streak {
            background: #8b5cf6;
            color: white;
        }

        .history-value {
            font-weight: bold;
            color: var(--primary);
        }

        .cloud-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            font-size: 13px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .cloud-status.synced {
            background: var(--success);
            color: white;
        }

        .cloud-status.syncing {
            background: var(--warning);
            color: white;
        }

        .cloud-status.error {
            background: var(--danger);
            color: white;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 22px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>üéÆ Bruno Mars e i suoi guadagni</h1>
            <p>Tu volere KEBAP? Tu volele sushi? Tu volere soldini? Tu bravo, tu ottiene!</p>
            <div class="token-display">Token Totali: <span id="totalTokens">...</span></div>
        </header>

        <div class="status">
            <div class="status-item"><span>Giorni senza penalit√†:</span><span id="streakDays">...</span></div>
            <div class="status-item"><span>Token da azioni base:</span><span id="baseTokens">...</span></div>
            <div class="status-item"><span>Token da azioni pro:</span><span id="proTokens">...</span></div>
            <div class="status-item"><span>Token da azioni VIP:</span><span id="vipTokens">...</span></div>
            <div class="status-item"><span>Token persi da penalit√†:</span><span id="penaltyTokens">...</span></div>
        </div>

        <div class="card">
            <h2>üìä Storico Token Ultimi</h2>
            <div class="history-list" id="historyList">
                <p style="color: var(--gray-700); font-size: 13px;">Caricamento...</p>
            </div>
        </div>

        <div class="edit-section">
            <h3 style="margin-bottom: 15px;">‚öôÔ∏è Gestione Token</h3>
            <div class="edit-controls">
                <input type="password" id="adminPassword" placeholder="Password admin" value="">
                <button class="btn-primary" onclick="checkPassword()">üîì Sblocca Modifiche</button>
            </div>
            <div id="editContent" style="display: none;">
                <div class="edit-controls">
                    <select id="tokenType">
                        <option value="base">üìå Token Base</option>
                        <option value="pro">‚≠ê Token Pro</option>
                        <option value="vip">üèÜ Token VIP</option>
                    </select>
                    <input type="number" id="tokenAmount" placeholder="Numero token" value="1" min="1">
                    <button class="btn-success" onclick="addTokenTyped()">+ Aggiungi Token</button>
                    <button class="btn-danger" onclick="removeTokenTyped()">- Rimuovi Token</button>
                </div>
                <div class="edit-controls">
                    <input type="number" id="penaltyAmount" placeholder="Penalit√†" value="1" min="1" max="2">
                    <button class="btn-danger" onclick="addPenalty()">Applica Penalit√†</button>
                </div>
                <div class="edit-controls">
                    <input type="number" id="streakInput" placeholder="Giorni senza penalit√†" value="1" min="1">
                    <button class="btn-primary" onclick="setStreakDays()">Imposta Giorni Senza Penalit√†</button>
                    <button class="btn-primary" onclick="addStreakDay()">+ 1 Giorno Senza Penalit√†</button>
                </div>
                <div class="edit-controls">
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--gray-200);">
                        <p style="margin-bottom: 5px; font-size: 13px; font-weight: bold; color: var(--success);">‚òÅÔ∏è
                            Firebase Sync Attivo</p>
                        <p style="margin-bottom: 10px; font-size: 12px; color: var(--gray-700);">I dati si sincronizzano
                            in tempo reale.</p>
                        <button class="btn-danger" onclick="resetData()" style="font-size: 12px;">üîÑ Reset
                            Totale</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid">
            <div class="card base-color">
                <h2>‚úÖ Livello Base (1 token)</h2>
                <div class="item-list">
                    <div class="item"><span class="item-name">Completare compiti scolastici</span><span
                            class="token-badge">1</span></div>
                    <div class="item"><span class="item-name">Riordinare quando chiesto da mamma</span><span
                            class="token-badge">1</span></div>
                    <div class="item"><span class="item-name">Rispettare il limite di tempo telefono (2 ore al giorno, 4
                            ore nei feriali)</span><span class="token-badge">1</span></div>
                    <div class="item"><span class="item-name">Mangiare tutto senza lamentarsi</span><span
                            class="token-badge">1</span></div>
                    <div class="item"><span class="item-name">Giocare con il cane per 20 minuti senza
                            distrazioni</span><span class="token-badge">1</span></div>
                    <div class="item"><span class="item-name">Bere un bicchiere d'acqua fuori pasto (max 5 punti al
                            giorno)</span><span class="token-badge">1</span></div>
                    <div class="item"><span class="item-name">Suonare la batteria elettrica per 30 minuti</span><span
                            class="token-badge">1</span></div>
                    <div class="item"><span class="item-name">Andare a letto entro le 22:30</span><span
                            class="token-badge">1</span></div>
                    <div class="item"><span class="item-name">Preparare lo zaino (1 token ogni 2 giorni)</span><span
                            class="token-badge">1</span></div>
                </div>
            </div>

            <div class="card pro-color">
                <h2>üåü Livello Pro (3 token)</h2>
                <div class="item-list">
                    <div class="item"><span class="item-name">Partecipare a visite mediche con coraggio</span><span
                            class="token-badge">3</span></div>
                    <div class="item"><span class="item-name">Leggere un libro di almeno 80 pagine (No
                            fumetti)</span><span class="token-badge">3</span></div>
                    <div class="item"><span class="item-name">Partecipare a un gioco di societ√† completo (no
                            smartphone)</span><span class="token-badge">3</span></div>
                    <div class="item"><span class="item-name">Imparare una ricetta seguendo chi sta
                            cucinando</span><span class="token-badge">3</span></div>
                    <div class="item"><span class="item-name">Chiacchierare dal vivo con un parente</span><span
                            class="token-badge">3</span></div>
                </div>
            </div>

            <div class="card vip-color">
                <h2>üèÜ Livello VIP (8 token)</h2>
                <div class="item-list">
                    <div class="item"><span class="item-name">Imparare a suonare un brano completo con la
                            batteria</span><span class="token-badge">8</span></div>
                    <div class="item"><span class="item-name">Creare un fumetto originale di almeno 8 tavole</span><span
                            class="token-badge">8</span></div>
                    <div class="item"><span class="item-name">Passare un giorno intero senza schermi (tv, smartphone,
                            tablet...)</span><span class="token-badge">8</span></div>
                    <div class="item"><span class="item-name">Prendere un voto alto (9 o 10)</span><span
                            class="token-badge">8</span></div>
                    <div class="item"><span class="item-name">Risparmiare i token per almeno 14 giorni anzich√©
                            spenderli</span><span class="token-badge">8</span></div>
                </div>
            </div>
        </div>

        <div class="card" style="border-top: 5px solid var(--danger);">
            <h2 style="color: var(--danger);">‚ö†Ô∏è Penalit√†</h2>
            <div class="penalties-grid">
                <div class="penalty-header">
                    <span>Azione</span>
                    <span>Costo</span>
                </div>
                <div class="penalty-row">
                    <span class="penalty-name">Lamentarsi durante i pasti</span>
                    <span class="penalty-badge">-1</span>
                </div>
                <div class="penalty-row">
                    <span class="penalty-name">Fare i capricci</span>
                    <span class="penalty-badge">-1</span>
                </div>
                <div class="penalty-row">
                    <span class="penalty-name">Telefono oltre limite</span>
                    <span class="penalty-badge">-2</span>
                </div>
                <div class="penalty-row">
                    <span class="penalty-name">Non completare compiti</span>
                    <span class="penalty-badge">-2</span>
                </div>
                <div class="penalty-row">
                    <span class="penalty-name">Non mantenere le promesse</span>
                    <span class="penalty-badge">-15</span>
                </div>
                <div class="penalty-row">
                    <span class="penalty-name">Voto negativo a scuola</span>
                    <span class="penalty-badge">-50</span>
                </div>
            </div>
            <p style="margin-top: 15px; font-size: 13px; color: var(--gray-700); font-style: italic;">
                * Le penalit√† resettano anche i giorni di streak accumulati.
            </p>
        </div>

        <div class="card">
            <h2>üéÅ Bonus Streak (Giorni senza penalit√†)</h2>
            <div class="item-list">
                <div class="item"><span class="item-name">7 giorni senza penalit√†</span><span
                        class="token-badge">1</span></div>
                <div class="item"><span class="item-name">14 giorni senza penalit√†</span><span
                        class="token-badge">3</span></div>
                <div class="item"><span class="item-name">21 giorni senza penalit√†</span><span
                        class="token-badge">6</span></div>
                <div class="item"><span class="item-name">28 giorni senza penalit√†</span><span
                        class="token-badge">10</span></div>
            </div>
        </div>

        <div class="card">
            <h2>üéÆ Premi (Scambio Token)</h2>
            <div class="section-title">60 Token</div>
            <div class="premi-item">
                <div class="premi-header">Opzione A: Ricarica Play Store</div>
                <div class="premi-option">Ricarica da 5 euro</div>
            </div>
            <div class="premi-item">
                <div class="premi-header">Opzione B: Cibo</div>
                <div class="premi-option">Kebab</div>
            </div>
            <div class="section-title">120 Token</div>
            <div class="premi-item">
                <div class="premi-header">Opzione A: Ricarica Play Store</div>
                <div class="premi-option">Ricarica da 10 euro</div>
            </div>
            <div class="premi-item">
                <div class="premi-header">Opzione B: Cibo</div>
                <div class="premi-option">McDonald's</div>
            </div>
            <div class="section-title">180 Token</div>
            <div class="premi-item">
                <div class="premi-header">Opzione A: Ricarica Play Store</div>
                <div class="premi-option">Ricarica da 20 euro</div>
            </div>
            <div class="premi-item">
                <div class="premi-header">Opzione B: Cibo</div>
                <div class="premi-option">Mangiare sushi</div>
            </div>
            <div
                style="background: var(--warning); color: white; padding: 15px; border-radius: 8px; margin-top: 20px; font-size: 13px;">
                ‚ÑπÔ∏è √à possibile barattare token per quello che vuole, purch√© sia d'accordo la mamma. Se non √® d'accordo,
                non insistere. Insistere comporta penalit√† di 3 token.</div>
        </div>

        <div class="footer">
            <p>Token Economy Tracker | Powered by Firebase Realtime Database</p>
        </div>
    </div>

    <!-- Status Cloud (in basso a destra) -->
    <div class="cloud-status syncing" id="cloudStatus">
        <span id="statusIcon">‚è≥</span>
        <span id="statusText">Connessione...</span>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-database.js"></script>

    <script>
        const ADMIN_PASSWORD = "FalkorMiuraFrechete";

        // ‚ö†Ô∏è SOSTITUISCI CON I TUOI DATI FIREBASE ‚ö†Ô∏è
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY_HERE",
            authDomain: "bruno-mars-tracker.firebaseapp.com",
            databaseURL: "https://bruno-mars-tracker-xxxxx.firebaseio.com",
            projectId: "bruno-mars-tracker",
            storageBucket: "bruno-mars-tracker.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Inizializza Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const dataRef = db.ref('bruno-mars-data');

        let localData = {
            totalTokens: 0,
            streakDays: 0,
            baseTokens: 0,
            proTokens: 0,
            vipTokens: 0,
            penaltyTokens: 0,
            history: []
        };

        // Creazione overlay di caricamento
        const loadingOverlay = document.createElement('div');
        loadingOverlay.style = "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.9);display:flex;justify-content:center;align-items:center;z-index:9999;flex-direction:column;font-family:sans-serif;";
        loadingOverlay.innerHTML = '<div style="font-size:30px;margin-bottom:10px;">‚òÅÔ∏è</div><div style="color:#3182f6;font-weight:bold;">Sincronizzazione con Firebase...</div>';
        document.body.appendChild(loadingOverlay);

        async function init() {
            try {
                // Ascolta i dati in tempo reale
                dataRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data && typeof data.baseTokens === 'number') {
                        localData = data;
                        console.log("‚úÖ Dati caricati da Firebase:", localData);
                        updateDisplay();
                        updateHistory();
                        updateCloudStatus('synced');
                    } else {
                        console.log("Firebase vuoto, inizializzo con dati locali");
                        updateCloudStatus('synced');
                    }
                    loadingOverlay.style.display = 'none';
                });

                // Listener per errori di connessione
                dataRef.on('error', (error) => {
                    console.error("‚ùå Errore Firebase:", error);
                    updateCloudStatus('error');
                    loadingOverlay.style.display = 'none';
                });

            } catch (err) {
                console.error("Errore inizializzazione:", err);
                updateCloudStatus('error');
                loadingOverlay.style.display = 'none';
            }
        }

        function updateCloudStatus(status) {
            const statusEl = document.getElementById('cloudStatus');
            const icon = document.getElementById('statusIcon');
            const text = document.getElementById('statusText');

            statusEl.className = 'cloud-status ' + status;

            if (status === 'syncing') {
                icon.textContent = '‚è≥';
                text.textContent = 'Sincronizzazione...';
            } else if (status === 'synced') {
                icon.textContent = '‚úÖ';
                text.textContent = 'Sincronizzato';
            } else if (status === 'error') {
                icon.textContent = '‚ùå';
                text.textContent = 'Errore connessione';
            }
        }

        function addToHistory(type, amount, description) {
            if (!localData.history) localData.history = [];

            const now = new Date();
            const timeStr = now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });

            localData.history.unshift({
                type: type,
                amount: amount,
                description: description,
                time: timeStr,
                date: now.toLocaleDateString('it-IT')
            });

            if (localData.history.length > 20) localData.history = localData.history.slice(0, 20);

            saveData(localData);
        }

        function updateHistory() {
            const historyList = document.getElementById('historyList');
            if (!localData.history || localData.history.length === 0) {
                historyList.innerHTML = '<p style="color: var(--gray-700); font-size: 13px;">Nessun movimento ancora...</p>';
                return;
            }

            let html = '';
            localData.history.forEach(item => {
                let typeClass = 'type-base';
                let typeEmoji = 'üìå';
                if (item.type === 'pro') { typeClass = 'type-pro'; typeEmoji = '‚≠ê'; }
                else if (item.type === 'vip') { typeClass = 'type-vip'; typeEmoji = 'üèÜ'; }
                else if (item.type === 'penalty') { typeClass = 'type-penalty'; typeEmoji = '‚ö†Ô∏è'; }
                else if (item.type === 'streak') { typeClass = 'type-streak'; typeEmoji = 'üéâ'; }

                const sign = item.amount > 0 ? '+' : '';
                const color = item.amount > 0 ? 'var(--success)' : 'var(--danger)';

                html += `
                    <div class="history-item">
                        <div>
                            <span class="history-type ${typeClass}">${typeEmoji} ${item.type.toUpperCase()}</span>
                            <span style="margin-left: 8px; font-size: 12px; color: var(--gray-700);">${item.time}</span>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: ${color}; font-weight: bold;">${sign}${item.amount}</div>
                        </div>
                    </div>`;
            });
            historyList.innerHTML = html;
        }

        function updateDisplay() {
            document.getElementById('totalTokens').textContent = localData.totalTokens;
            document.getElementById('streakDays').textContent = localData.streakDays;
            document.getElementById('baseTokens').textContent = localData.baseTokens;
            document.getElementById('proTokens').textContent = localData.proTokens;
            document.getElementById('vipTokens').textContent = localData.vipTokens;
            document.getElementById('penaltyTokens').textContent = localData.penaltyTokens;
        }

        function saveData(data) {
            updateCloudStatus('syncing');
            dataRef.set(data).then(() => {
                console.log("‚úÖ Dati salvati su Firebase");
                updateCloudStatus('synced');
            }).catch((err) => {
                console.error("‚ùå Errore salvataggio Firebase:", err);
                updateCloudStatus('error');
                alert("‚ö†Ô∏è Errore: Impossibile salvare. Controlla la connessione e la configurazione Firebase.");
            });
        }

        function checkPassword() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                document.getElementById('editContent').style.display = 'block';
                document.getElementById('adminPassword').style.display = 'none';
                document.querySelector('button[onclick="checkPassword()"]').style.display = 'none';
                alert('üîì Accesso sbloccato!');
            } else if (password === '') {
                alert('‚ö†Ô∏è Inserisci la password');
            } else {
                alert('‚ùå Password sbagliata!');
                document.getElementById('adminPassword').value = '';
            }
        }

        function addTokenTyped() {
            const amount = parseInt(document.getElementById('tokenAmount').value) || 1;
            const type = document.getElementById('tokenType').value;

            localData.totalTokens += amount;
            if (type === 'base') localData.baseTokens += amount;
            else if (type === 'pro') localData.proTokens += amount;
            else if (type === 'vip') localData.vipTokens += amount;

            addToHistory(type, amount, `Aggiunti ${amount} token ${type}`);
            updateDisplay();
            alert(`‚úÖ Aggiunti ${amount} token ${type.toUpperCase()}!`);
        }

        function removeTokenTyped() {
            const amount = parseInt(document.getElementById('tokenAmount').value) || 1;
            const type = document.getElementById('tokenType').value;

            localData.totalTokens = Math.max(0, localData.totalTokens - amount);
            if (type === 'base') localData.baseTokens = Math.max(0, localData.baseTokens - amount);
            else if (type === 'pro') localData.proTokens = Math.max(0, localData.proTokens - amount);
            else if (type === 'vip') localData.vipTokens = Math.max(0, localData.vipTokens - amount);

            addToHistory(type, -amount, `Rimossi ${amount} token ${type}`);
            updateDisplay();
            alert(`‚ùå Rimossi ${amount} token ${type.toUpperCase()}!`);
        }

        function addPenalty() {
            const amount = parseInt(document.getElementById('penaltyAmount').value) || 1;
            localData.totalTokens = Math.max(0, localData.totalTokens - amount);
            localData.penaltyTokens += amount;
            localData.streakDays = 0;
            addToHistory('penalty', -amount, `Penalit√† applicata`);
            updateDisplay();
            alert(`‚ö†Ô∏è Applicata penalit√† di ${amount} token! Streak resettato.`);
        }

        function addStreakDay() {
            localData.streakDays += 1;
            if ([7, 14, 21, 28].includes(localData.streakDays)) {
                const rewards = { 7: 1, 14: 3, 21: 6, 28: 10 };
                const bonus = rewards[localData.streakDays];
                localData.totalTokens += bonus;
                saveData(localData);
                updateDisplay();
                addToHistory('streak', bonus, `Bonus ${localData.streakDays} giorni`);
                alert(`üéâ Complimenti! ${localData.streakDays} giorni senza penalit√†! Bonus: +${bonus} token!`);
            } else {
                saveData(localData);
                updateDisplay();
                addToHistory('streak', 0, `+1 giorno streak`);
            }
        }

        function setStreakDays() {
            const days = parseInt(document.getElementById('streakInput').value) || 1;
            localData.streakDays = days;
            addToHistory('streak', 0, `Impostati ${days} giorni`);
            updateDisplay();
            alert(`‚úÖ Impostati ${days} giorni!`);
        }

        function resetData() {
            if (confirm('ATTENZIONE: Questo canceller√† TUTTO dal Cloud. Sicuro?')) {
                localData = {
                    totalTokens: 0, streakDays: 0, baseTokens: 0, proTokens: 0, vipTokens: 0, penaltyTokens: 0, history: []
                };
                saveData(localData);
                updateDisplay();
                updateHistory();
                alert('üîÑ Dati resettati!');
            }
        }

        // START
        init();
    </script>
</body>

</html>
