<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Economy Tracker - Cloud</title>
    <style>
        :root {
            --primary: #3182f6; --primary-dark: #2563eb; --success: #10b981;
            --danger: #ef4444; --danger-dark: #b91c1c; --warning: #f59e0b; 
            --gray-100: #f3f4f6; --gray-200: #e5e7eb; --gray-700: #374151; --gray-900: #111827;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--gray-100); color: var(--gray-900); padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* HEADER */
        header { background: white; padding: 20px; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        h1 { font-size: 28px; margin-bottom: 10px; }
        header p { color: var(--gray-700); font-style: italic; margin-bottom: 15px; }
        .token-display { font-size: 24px; color: var(--primary); font-weight: bold; margin: 15px 0; }
        
        /* LAYOUT GRIGLIE */
        .card-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
        
        /* CARD INTERATTIVE */
        .action-card {
            padding: 15px 10px; border-radius: 12px; text-align: center;
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
            height: 100%; cursor: not-allowed; opacity: 0.7; transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); background: white; border: 2px solid transparent; min-height: 140px;
        }
        
        /* Quando sbloccato */
        body.admin-unlocked .action-card { cursor: pointer; opacity: 1; }
        body.admin-unlocked .action-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        body.admin-unlocked .action-card:active { transform: scale(0.98); }

        .card-icon { font-size: 32px; margin-bottom: 10px; }
        .card-desc { font-size: 13px; font-weight: 600; line-height: 1.3; margin-bottom: 10px; flex-grow: 1; display: flex; align-items: center; justify-content: center; }
        .card-badge { padding: 4px 12px; border-radius: 20px; font-weight: 800; font-size: 14px; }

        /* Colori Card */
        .style-base { border-color: #d1fae5; background: #ecfdf5; color: #065f46; }
        .style-base .card-badge { background: var(--success); color: white; }
        .style-base:hover { border-color: var(--success); }

        .style-pro { border-color: #fef3c7; background: #fffbeb; color: #92400e; }
        .style-pro .card-badge { background: var(--warning); color: white; }
        .style-pro:hover { border-color: var(--warning); }

        .style-vip { border-color: #fee2e2; background: #fef2f2; color: #991b1b; }
        .style-vip .card-badge { background: var(--danger); color: white; }
        .style-vip:hover { border-color: var(--danger); }

        .style-penalty { border-color: #fee2e2; background: #fff1f2; color: var(--danger); }
        .style-penalty .card-badge { background: white; color: var(--danger); border: 1px solid var(--danger); }
        .style-penalty:hover { border-color: var(--danger); box-shadow: 0 0 10px rgba(239, 68, 68, 0.2); }

        .style-severe { background: #fee2e2; border: 2px solid #ef4444; }
        .style-severe .card-badge { background: var(--danger); color: white; border: none; }

        /* SEZIONI GENERALI */
        .main-section { background: white; padding: 20px; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .main-section h2 { font-size: 18px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--gray-200); }
        .base-header { border-color: var(--success) !important; color: var(--success); }
        .pro-header { border-color: var(--warning) !important; color: #d97706; }
        .vip-header { border-color: var(--danger) !important; color: var(--danger); }
        .penalty-header { border-color: var(--danger) !important; color: var(--danger); }

        /* STATUS E STORICO */
        .status { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .status-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--gray-200); }
        .history-list { max-height: 300px; overflow-y: auto; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--gray-100); border-radius: 6px; margin-bottom: 8px; font-size: 13px; }
        .history-type { padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 11px; }
        
        .type-base { background: var(--success); color: white; }
        .type-pro { background: var(--warning); color: white; }
        .type-vip { background: var(--danger); color: white; }
        .type-penalty { background: #6b7280; color: white; }
        .type-streak { background: #8b5cf6; color: white; }

        /* ADMIN SECTION */
        .edit-section { background: var(--gray-100); padding: 20px; border-radius: 10px; margin: 30px 0; border: 2px solid var(--primary); }
        .edit-controls { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
        .reason-input { width: 100%; padding: 12px; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 16px; margin-bottom: 15px; }

        /* PREMI SECTION */
        .section-title { background: var(--primary); color: white; padding: 10px; border-radius: 6px; margin: 15px 0 10px; font-weight: bold; font-size: 14px; }
        .premi-item { background: var(--gray-100); padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .premi-header { font-weight: bold; color: var(--primary); }
        .premi-option { font-size: 13px; color: var(--gray-700); }

        /* UI GENERALE */
        input, select, button { padding: 8px 12px; border-radius: 6px; font-size: 14px; border: 1px solid #ddd; }
        button { cursor: pointer; border: none; color: white; font-weight: bold; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        #lockMessage { text-align: center; background: #fff3cd; color: #854d0e; padding: 10px; border-radius: 8px; margin-bottom: 20px; display: block; border: 1px solid #fde68a; }
        .footer { background: white; padding: 20px; border-radius: 10px; text-align: center; font-size: 13px; color: var(--gray-700); margin-top: 30px; }
        
        @media (max-width: 768px) { .card-container { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéÆ Bruno Mars e i suoi guadagni</h1>
            <p>Tu volere KEBAP? Tu volele sushi? Tu volere soldini? Tu bravo, tu ottiene!</p>
            <div id="loading" style="color: var(--primary); font-weight: bold;">üì° Connessione...</div>
            <div class="token-display">Token Totali: <span id="totalTokens">...</span></div>
        </header>

        <div id="lockMessage">üîí <strong>Modalit√† sola lettura.</strong> Inserisci la password sotto per abilitare i click!</div>

        <div class="status">
            <div class="status-item"><span>Giorni senza penalit√†:</span><span id="streakDays" style="font-weight:bold; color:purple;">...</span></div>
            <div class="status-item"><span>Token da azioni base:</span><span id="baseTokens">...</span></div>
            <div class="status-item"><span>Token da azioni pro:</span><span id="proTokens">...</span></div>
            <div class="status-item"><span>Token da azioni VIP:</span><span id="vipTokens">...</span></div>
            <div class="status-item"><span>Token persi da penalit√†:</span><span id="penaltyTokens">...</span></div>
        </div>

        <div class="main-section">
            <h2>üìä Ultimi Movimenti</h2>
            <div class="history-list" id="historyList">Loading...</div>
        </div>

        <div class="edit-section">
            <h3 style="margin-bottom:15px;">‚öôÔ∏è Gestione Token</h3>
            <div class="edit-controls">
                <input type="password" id="adminPassword" placeholder="Password admin">
                <button class="btn-primary" onclick="window.checkPassword()">üîì Sblocca Click & Modifiche</button>
            </div>
            
            <div id="editContent" style="display: none;">
                <input type="text" id="customReason" class="reason-input" placeholder="üìù Motivo personalizzato (es. Compiti extra)">
                <div class="edit-controls">
                    <select id="tokenType"><option value="base">Base</option><option value="pro">Pro</option><option value="vip">VIP</option></select>
                    <input type="number" id="tokenAmount" value="1" style="width: 60px;">
                    <button class="btn-success" onclick="window.addTokenTyped()">+ Aggiungi</button>
                    <button class="btn-danger" onclick="window.removeTokenTyped()">- Rimuovi</button>
                </div>
                <div class="edit-controls">
                    <button class="btn-primary" onclick="window.addStreakDay()">+1 Giorno Streak</button>
                    <button class="btn-danger" onclick="window.resetData()">RESET TOTALE</button>
                </div>
            </div>
        </div>

        <div class="main-section">
            <h2 class="base-header">‚úÖ Livello Base (+1 Token)</h2>
            <div class="card-container">
                <div class="action-card style-base" onclick="window.clickTask(1, 'base', 'Compiti scolastici')">
                    <div class="card-icon">üìö</div><div class="card-desc">Compiti fatti</div><div class="card-badge">+1</div>
                </div>
                <div class="action-card style-base" onclick="window.clickTask(1, 'base', 'Riordinato stanza')">
                    <div class="card-icon">üßπ</div><div class="card-desc">Riordinare</div><div class="card-badge">+1</div>
                </div>
                <div class="action-card style-base" onclick="window.clickTask(1, 'base', 'Limite telefono rispettato')">
                    <div class="card-icon">üìµ</div><div class="card-desc">Limite Telefono</div><div class="card-badge">+1</div>
                </div>
                <div class="action-card style-base" onclick="window.clickTask(1, 'base', 'Mangiato tutto')">
                    <div class="card-icon">üçΩÔ∏è</div><div class="card-desc">Mangiato tutto</div><div class="card-badge">+1</div>
                </div>
                <div class="action-card style-base" onclick="window.clickTask(1, 'base', 'Giocato col cane')">
                    <div class="card-icon">üêï</div><div class="card-desc">Cura Cane</div><div class="card-badge">+1</div>
                </div>
                <div class="action-card style-base" onclick="window.clickTask(1, 'base', 'Bevuto acqua')">
                    <div class="card-icon">üíß</div><div class="card-desc">Bere Acqua</div><div class="card-badge">+1</div>
                </div>
                <div class="action-card style-base" onclick="window.clickTask(1, 'base', 'Suonato batteria 30m')">
                    <div class="card-icon">ü•Å</div><div class="card-desc">Batteria 30m</div><div class="card-badge">+1</div>
                </div>
            </div>
        </div>

        <div class="main-section">
            <h2 class="pro-header">üåü Livello Pro (+3 Token)</h2>
            <div class="card-container">
                <div class="action-card style-pro" onclick="window.clickTask(3, 'pro', 'Visita medica coraggiosa')">
                    <div class="card-icon">üè•</div><div class="card-desc">Visita Medica</div><div class="card-badge">+3</div>
                </div>
                <div class="action-card style-pro" onclick="window.clickTask(3, 'pro', 'Letto libro 80pag')">
                    <div class="card-icon">üìñ</div><div class="card-desc">Libro 80 pag.</div><div class="card-badge">+3</div>
                </div>
                <div class="action-card style-pro" onclick="window.clickTask(3, 'pro', 'Gioco societ√†')">
                    <div class="card-icon">üé≤</div><div class="card-desc">Gioco Societ√†</div><div class="card-badge">+3</div>
                </div>
                <div class="action-card style-pro" onclick="window.clickTask(3, 'pro', 'Imparato ricetta')">
                    <div class="card-icon">üë®‚Äçüç≥</div><div class="card-desc">Cucina/Ricetta</div><div class="card-badge">+3</div>
                </div>
            </div>
        </div>

        <div class="main-section">
            <h2 class="vip-header">üèÜ Livello VIP (+8 Token)</h2>
            <div class="card-container">
                <div class="action-card style-vip" onclick="window.clickTask(8, 'vip', 'Brano completo batteria')">
                    <div class="card-icon">üéµ</div><div class="card-desc">Brano Completo</div><div class="card-badge">+8</div>
                </div>
                <div class="action-card style-vip" onclick="window.clickTask(8, 'vip', 'Fumetto 8 tavole')">
                    <div class="card-icon">üé®</div><div class="card-desc">Fumetto 8 Tav.</div><div class="card-badge">+8</div>
                </div>
                <div class="action-card style-vip" onclick="window.clickTask(8, 'vip', '24h No Schermi')">
                    <div class="card-icon">üå≥</div><div class="card-desc">24h No Schermi</div><div class="card-badge">+8</div>
                </div>
            </div>
        </div>

        <div class="main-section">
            <h2 class="penalty-header">‚ö†Ô∏è Penalit√† (Click to Punish!)</h2>
            <div class="card-container">
                <div class="action-card style-penalty" onclick="window.clickPenalty(2, 'Telefono oltre limite')">
                    <div class="card-icon">üì±</div><div class="card-desc">Troppo Telefono</div><div class="card-badge">-2</div>
                </div>
                <div class="action-card style-penalty" onclick="window.clickPenalty(1, 'Lamenti ai pasti')">
                    <div class="card-icon">üçΩÔ∏è</div><div class="card-desc">Lamenti Cibo</div><div class="card-badge">-1</div>
                </div>
                <div class="action-card style-penalty" onclick="window.clickPenalty(2, 'Compiti non fatti')">
                    <div class="card-icon">üìö</div><div class="card-desc">Niente Compiti</div><div class="card-badge">-2</div>
                </div>
                <div class="action-card style-penalty" onclick="window.clickPenalty(1, 'Capricci')">
                    <div class="card-icon">üò≠</div><div class="card-desc">Capricci</div><div class="card-badge">-1</div>
                </div>
                <div class="action-card style-severe" onclick="window.clickPenalty(15, 'Promessa non mantenuta')">
                    <div class="card-icon">ü§•</div><div class="card-desc">Promessa Rotta</div><div class="card-badge">-15</div>
                </div>
                <div class="action-card style-severe" onclick="window.clickPenalty(50, 'Voto negativo')">
                    <div class="card-icon">üìâ</div><div class="card-desc">Voto Negativo</div><div class="card-badge">-50</div>
                </div>
            </div>
        </div>

        <div class="main-section">
            <h2>üéÅ Premi Disponibili</h2>
            
            <div class="section-title">60 Token</div>
            <div class="premi-item"><div class="premi-header">Ricarica Play Store</div><div class="premi-option">5 euro</div></div>
            <div class="premi-item"><div class="premi-header">Cibo</div><div class="premi-option">Kebab</div></div>
            
            <div class="section-title">120 Token</div>
            <div class="premi-item"><div class="premi-header">Ricarica Play Store</div><div class="premi-option">10 euro</div></div>
            <div class="premi-item"><div class="premi-header">Cibo</div><div class="premi-option">McDonald's</div></div>
            
            <div class="section-title">180 Token</div>
            <div class="premi-item"><div class="premi-header">Ricarica Play Store</div><div class="premi-option">20 euro</div></div>
            <div class="premi-item"><div class="premi-header">Cibo</div><div class="premi-option">Sushi</div></div>
        </div>

        <div class="footer">
            <p>Token Economy Tracker | Bruno Mars Edition</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCBFhqkOB9ZsNbEo2EUQWOK9Q7OMVCkarc",
            authDomain: "brunomarstokens.firebaseapp.com",
            databaseURL: "https://brunomarstokens-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "brunomarstokens",
            storageBucket: "brunomarstokens.firebasestorage.app",
            messagingSenderId: "457405323641",
            appId: "1:457405323641:web:7c9576d87b8a540b7fb7a8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dbRef = ref(db, 'tokenEconomy');
        const ADMIN_PASSWORD = "FalkorMiuraFrechete";

        // STATO GLOBALE
        let isAdminUnlocked = false;
        let currentData = {
            totalTokens: 0, streakDays: 0, baseTokens: 0,
            proTokens: 0, vipTokens: 0, penaltyTokens: 0, history: []
        };

        // SYNC
        document.getElementById('loading').style.display = 'block';
        onValue(dbRef, (snapshot) => {
            const data = snapshot.val();
            document.getElementById('loading').style.display = 'none';
            if (data) {
                currentData = data;
                if (!currentData.history) currentData.history = [];
            } else { saveDataToCloud(); }
            updateDisplay();
            updateHistory();
        });

        function saveDataToCloud() {
            set(dbRef, currentData).catch((e) => alert("Errore Cloud: " + e));
        }

        // --- FUNZIONI CORE ---

        // Funzione helper per aggiungere allo storico
        function addToHistory(type, amount, description) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
            if (!currentData.history) currentData.history = [];
            currentData.history.unshift({
                type: type, amount: amount, description: description,
                time: timeStr, date: now.toLocaleDateString('it-IT')
            });
            if (currentData.history.length > 25) currentData.history = currentData.history.slice(0, 25);
            saveDataToCloud();
        }

        // --- GESTIONE CLICK RAPIDI ---
        
        window.clickTask = function(amount, type, description) {
            if (!isAdminUnlocked) {
                alert("üîí BLOCCATO! Un genitore deve inserire la password sotto lo storico.");
                return;
            }
            
            // Logica aggiunta
            currentData.totalTokens += amount;
            if (type === 'base') currentData.baseTokens += amount;
            else if (type === 'pro') currentData.proTokens += amount;
            else if (type === 'vip') currentData.vipTokens += amount;

            addToHistory(type, amount, description);
        }

        window.clickPenalty = function(amount, description) {
            if (!isAdminUnlocked) {
                alert("üîí BLOCCATO! Inserisci la password per dare penalit√†.");
                return;
            }
            
            if(confirm(`Sei sicuro di dare la penalit√†: ${description}?`)) {
                currentData.totalTokens = Math.max(0, currentData.totalTokens - amount);
                currentData.penaltyTokens += amount;
                currentData.streakDays = 0; // Reset streak
                addToHistory('penalty', -amount, description);
            }
        }

        // --- GESTIONE MANUALE ---

        window.addTokenTyped = function() {
            const amount = parseInt(document.getElementById('tokenAmount').value) || 1;
            const type = document.getElementById('tokenType').value;
            const customReason = document.getElementById('customReason').value.trim();
            const reason = customReason !== "" ? customReason : "Aggiunta manuale";

            window.clickTask(amount, type, reason); // Riutilizza la funzione clickTask
            document.getElementById('customReason').value = "";
        }

        window.removeTokenTyped = function() {
            const amount = parseInt(document.getElementById('tokenAmount').value) || 1;
            const type = document.getElementById('tokenType').value;
            const customReason = document.getElementById('customReason').value.trim();
            
            currentData.totalTokens = Math.max(0, currentData.totalTokens - amount);
            if (type === 'base') currentData.baseTokens = Math.max(0, currentData.baseTokens - amount);
            else if (type === 'pro') currentData.proTokens = Math.max(0, currentData.proTokens - amount);
            else if (type === 'vip') currentData.vipTokens = Math.max(0, currentData.vipTokens - amount);
            
            addToHistory(type, -amount, customReason || "Rimozione manuale");
            alert(`‚ùå Rimossi ${amount} token`);
        }

        window.addStreakDay = function() {
            currentData.streakDays += 1;
            const days = currentData.streakDays;
            const rewards = { 7: 1, 14: 3, 21: 6, 28: 10 };
            
            if (rewards[days]) {
                currentData.totalTokens += rewards[days];
                addToHistory('streak', rewards[days], `Bonus Streak ${days} gg!`);
                alert(`üéâ Bonus Streak ${days} giorni! +${rewards[days]} token`);
            } else {
                addToHistory('streak', 0, `Streak: ${days} giorni`);
                saveDataToCloud();
            }
        }

        window.resetData = function() {
            if (confirm('SICURO? Cancella tutto per sempre.')) {
                currentData = { totalTokens: 0, streakDays: 0, baseTokens: 0, proTokens: 0, vipTokens: 0, penaltyTokens: 0, history: [] };
                saveDataToCloud();
            }
        }

        // --- SISTEMA PASSWORD & UI ---

        window.checkPassword = function() {
            const pwd = document.getElementById('adminPassword').value;
            if (pwd === ADMIN_PASSWORD) {
                isAdminUnlocked = true;
                document.body.classList.add('admin-unlocked'); // Attiva CSS interattivo
                document.getElementById('editContent').style.display = 'block';
                document.getElementById('lockMessage').style.display = 'none';
                document.getElementById('adminPassword').value = '';
                document.querySelector('button[onclick="window.checkPassword()"]').style.display = 'none';
                alert("üîì Sbloccato! Ora puoi cliccare le card.");
            } else {
                alert("Password errata!");
            }
        }

        function updateDisplay() {
            document.getElementById('totalTokens').textContent = currentData.totalTokens;
            document.getElementById('streakDays').textContent = currentData.streakDays;
            document.getElementById('baseTokens').textContent = currentData.baseTokens;
            document.getElementById('proTokens').textContent = currentData.proTokens;
            document.getElementById('vipTokens').textContent = currentData.vipTokens;
            document.getElementById('penaltyTokens').textContent = currentData.penaltyTokens;
        }

        function updateHistory() {
            const list = document.getElementById('historyList');
            if (!currentData.history.length) { list.innerHTML = 'Wait for it...'; return; }
            
            let html = '';
            currentData.history.forEach(item => {
                let cl = 'type-base', em = 'üìå', col = 'var(--success)', sign='+';
                if(item.type=='pro'){cl='type-pro'; em='‚≠ê';}
                if(item.type=='vip'){cl='type-vip'; em='üèÜ'; col='var(--danger)';}
                if(item.type=='penalty'){cl='type-penalty'; em='‚ö†Ô∏è'; col='var(--danger)'; sign='';}
                if(item.type=='streak'){cl='type-streak'; em='üî•';}
                if(item.amount < 0) { col='var(--danger)'; sign=''; }

                html += `<div class="history-item">
                    <div><span class="history-type ${cl}">${em}</span> <span style="margin-left:5px; color:#444;">${item.description}</span></div>
                    <div style="font-weight:bold; color:${col}">${sign}${item.amount}</div>
                </div>`;
            });
            list.innerHTML = html;
        }
    </script>
</body>
</html>
